<!DOCTYPE>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>unhosted social dashboard example</title>
    
    <script src="codemirror-3.0/lib/codemirror.js"></script>
    <link rel="stylesheet" href="codemirror-3.0/lib/codemirror.css" />
    
    <script src="codemirror-3.0/mode/xml/xml.js"></script>
    <script src="codemirror-3.0/mode/javascript/javascript.js"></script>
    <script src="codemirror-3.0/mode/css/css.js"></script>
    <script src="codemirror-3.0/mode/htmlmixed/htmlmixed.js"></script>
    <script src="codemirror-3.0/mode/markdown/markdown.js"></script>
    <script src="codemirror-3.0/mode/clike/clike.js"></script>
    <script src="codemirror-3.0/mode/php/php.js"></script>
      
    <script src="codemirror-3.0/lib/util/search.js"></script>
    <script src="codemirror-3.0/lib/util/searchcursor.js"></script>
    <script src="codemirror-3.0/lib/util/dialog.js"></script>
    <style>
      #editor { border-style: solid }
    </style>
  </head>
  <body>
    <h1>This app requires a Sockethub server.</h1>
    <p>
      <a href="http://sockethub.org/">Sockethub</a> server:
      <ul>
        <li>Domain and port: <input id="sockethubServer" value="localhost:10550" /></li>
        <li>Secret: <input id="sockethubSecret" value="1234567890" /></li>
      </ul>
      <input type="submit" value="connect" onclick="connect();" />
    </p>
    <p>
      SMTP credentials:
      <ul>
        <li>Host: <input id="smtpHost" /></li>
        <li>User: <input id="smtpUser" /></li>
        <li>Password: <input id="smtpPassword" /></li>
      </ul>
    </p>
    <p>   
      Subject: <input id="subject" style="width:70em" />
      To: <input id="to" />
      Ref: <input id="ref" />
      <input type="submit" value="send" onclick="send();" />
      <div id="editor"></div>
   </p>
   <h1>Log:</h1>
   <ul id="log">
   </ul>
  </body>
  <script src="sockethub.js"></script>
  <script>
    var myCodeMirror = new CodeMirror(document.getElementById('editor'));

    function value(id, val) {
      if(val) {
        document.getElementById(id).value = val;
      }
      return document.getElementById(id).value;
    }
    function log(msg) {
      if(typeof(msg) != 'string') {
        msg = JSON.stringify(msg);
      }
      document.getElementById('log').innerHTML += '<li>'+msg+'</li>';
    }
    function getCredentials() {
      var creds = {
        host: value('smtpHost'),
        user: value('smtpUser'),
        password: value('smtpPassword')
      };
      localStorage.setItem('smtp-credentials', JSON.stringify(creds));
      return creds;
    }
    function reviveCredentials() {
      var credsStr = localStorage.getItem('smtp-credentials');
      if(typeof(credsStr) == 'string') {
        try {
          creds = JSON.parse(credsStr);
        } catch(e) {
          return;
        }
        value('smtpHost', creds.host);
        value('smtpUser', creds.user);
        value('smtpPassword', creds.password);
      }
    }
    function connect() {
      sockethub.connect(value('sockethubServer'), value('sockethubSecret'));
      sockethub.on('ready', function() {
        log('ready');
      });
      sockethub.on('error', log);
      sockethub.on('activity', log);
    }
    function send() {
      sockethub.send('smtp', getCredentials(), {
        actor: {
          address: 'michiel@michielbdejong.com'
        },
        object: {
          body: myCodeMirror.getValue(),
          subject: value('subject'),
          ref: value('ref')
        },
        target: {
          to: value('to').split(',')
        }
      });
    }
    log('Ready for you to click "Connect"');
    reviveCredentials();
  </script>
</html>
